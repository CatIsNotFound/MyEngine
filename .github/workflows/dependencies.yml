name: Compile and Install Project
on:
  workflow_call:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  env-linux:
    runs-on: ubuntu-latest

    steps:
      - name: pull code
        uses: actions/checkout@v4

      - name: Downloading and Installing requirements
        shell: bash
        run: |
           sudo apt-get update 
           sudo apt-get install build-essential git make pkg-config cmake ninja-build \
                                gnome-desktop-testing libasound2-dev libpulse-dev libaudio-dev \
                                libfribidi-dev libjack-dev libsndio-dev libx11-dev libxext-dev \
                                libxrandr-dev libxcursor-dev libxfixes-dev libxi-dev libxss-dev \
                                libxtst-dev libxkbcommon-dev libdrm-dev libgbm-dev libgl1-mesa-dev \
                                libgles2-mesa-dev libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev \
                                libudev-dev libthai-dev libpipewire-0.3-dev libwayland-dev libdecor-0-dev \
                                liburing-dev libpng-dev libjpeg-dev libflac-dev libwavpack-dev libxmp-dev \
                                libogg-dev  libmpg123-dev libfreetype-dev libharfbuzz-dev -y 
           mkdir -p ~/Libs
           mkdir -p ~/git ; cd ~/git
           git clone --depth 1 https://github.com/libsdl-org/SDL 
           git clone --depth 1 https://github.com/libsdl-org/SDL_image 
           git clone --depth 1 https://github.com/libsdl-org/SDL_mixer 
           git clone --depth 1 https://github.com/libsdl-org/SDL_ttf
          
           echo "~/git: "
           ls ~/git
        
      - name: Compiling and installing SDL3
        shell: bash
        run: |
          cd ~/git/SDL
          mkdir -p build ; cd build
          echo "* Starting configure SDL3...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL_TEST=OFF -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3
          echo "* Compiling and installing SDL3...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_image
        shell: bash
        run: |
          cd ~/git/SDL_image
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_image...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_image
          echo "* Compiling and installing SDL3_image...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_mixer
        shell: bash
        run: |
          cd ~/git/SDL_mixer
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_mixer...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_mixer
          echo "* Compiling and installing SDL3_mixer...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_ttf
        shell: bash
        run: |
          cd ~/git/SDL_ttf
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_ttf...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_ttf
          echo "* Compiling and installing SDL3_ttf...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
          fi

      - name: Compiling and installing project
        shell: bash
        run: |
          mkdir -p build ; cd build
          echo "* Configuring project..."
          cmake .. -DSDL3_LIB=~/Libs/SDL3 \
                   -DSDL3_IMAGE_LIB=~/Libs/SDL3_image \
                   -DSDL3_MIXER_LIB=~/Libs/SDL3_mixer \
                   -DSDL3_TTF_LIB=~/Libs/SDL3_ttf \
                   -DBUILD_TEST=OFF \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_INSTALL_PREFIX=~/Libs/MyEngine
          echo "* Compiling and installing project..."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No errors occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi
      
  env-macos:
    runs-on: macos-latest
    steps:
      - name: pull code
        uses: actions/checkout@v4

      - name: Downloading and Installing requirements
        shell: bash
        run: |
          brew update
          brew install cmake pkg-config ninja 
          
          mkdir -p ~/Libs
          mkdir -p ~/git ; cd ~/git
          git clone --depth 1 https://github.com/libsdl-org/SDL 
          git clone --depth 1 https://github.com/libsdl-org/SDL_image 
          git clone --depth 1 https://github.com/libsdl-org/SDL_mixer 
          git clone --depth 1 https://github.com/libsdl-org/SDL_ttf
          
          echo "~/git: "
          ls ~/git

      - name: Compiling and installing SDL3
        shell: bash
        run: |
          cd ~/git/SDL
          mkdir -p build ; cd build
          echo "* Starting configure SDL3...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DSDL_TEST=OFF -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3
          echo "* Compiling and installing SDL3...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_image
        shell: bash
        run: |
          cd ~/git/SDL_image
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_image...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_image
          echo "* Compiling and installing SDL3_image...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_mixer
        shell: bash
        run: |
          cd ~/git/SDL_mixer
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_mixer...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_mixer
          echo "* Compiling and installing SDL3_mixer...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing SDL3_ttf
        shell: bash
        run: |
          cd ~/git/SDL_ttf
          mkdir -p build ; cd build
          echo "* Starting configure SDL3_ttf...."
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=~/Libs/SDL3 -DCMAKE_INSTALL_PREFIX=~/Libs/SDL3_ttf
          echo "* Compiling and installing SDL3_ttf...."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No error occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi

      - name: Compiling and installing project
        shell: bash
        run: |
          mkdir -p build ; cd build
          echo "* Configuring project..."
          cmake .. -DSDL3_LIB=~/Libs/SDL3 \
                   -DSDL3_IMAGE_LIB=~/Libs/SDL3_image \
                   -DSDL3_MIXER_LIB=~/Libs/SDL3_mixer \
                   -DSDL3_TTF_LIB=~/Libs/SDL3_ttf \
                   -DBUILD_TEST=OFF \
                   -DCMAKE_BUILD_TYPE=Release \
                   -DCMAKE_INSTALL_PREFIX=~/Libs/MyEngine
          echo "* Compiling and installing project..."
          cmake --build . -j4 --target install
          if [ $? -eq 0 ]; then
              echo "* No errors occurred, finished! "
          else
              echo "* Failed to compile and install! "
              exit 1
          fi
      
      
  env-windows-msvc:
    runs-on: windows-latest
    steps:
      - name: pull code
        uses: actions/checkout@v4

      - name: Setup Visual Studio Build Tools
        uses: ilammy/msvc-dev-cmd@v1  # 配置 MSVC 环境变量

      - name: Install dependencies (vcpkg)
        shell: pwsh
        run: |
          # 安装 vcpkg 并配置
          git clone --depth 1 https://github.com/microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat -disableMetrics
          # 安装 SDL 依赖的第三方库（MSVC 版本）
          # C:\vcpkg\vcpkg install libpng:x64-windows libjpeg-turbo:x64-windows libflac:x64-windows libogg:x64-windows libvorbis:x64-windows mpg123:x64-windows freetype:x64-windows harfbuzz:x64-windows libwebp:x64-windows
          # 设置 vcpkg 根目录
          echo "VCPKG_ROOT=C:\vcpkg" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Download SDL source code
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path $HOME\Libs -Force
          New-Item -ItemType Directory -Path $HOME\git -Force
          cd $HOME\git
          git clone --depth 1 https://github.com/libsdl-org/SDL
          git clone --depth 1 https://github.com/libsdl-org/SDL_image
          git clone --depth 1 https://github.com/libsdl-org/SDL_mixer
          git clone --depth 1 https://github.com/libsdl-org/SDL_ttf
          # 列出目录内容
          Get-ChildItem $HOME\git

      - name: Compiling and installing SDL3 (MSVC)
        shell: pwsh
        run: |
          cd $HOME\git\SDL
          New-Item -ItemType Directory -Path build -Force
          cd build
          Write-Host "* Starting configure SDL3...."
          # 使用 MSVC 生成器，通过 vcpkg 链接依赖
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DSDL_TEST=OFF `
            -DCMAKE_INSTALL_PREFIX="$HOME\Libs\SDL3" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          Write-Host "* Compiling and installing SDL3...."
          # 编译并安装（--config 指定 Release 配置）
          cmake --build . -j4 --config Release --target install
          if ($LASTEXITCODE -eq 0) {
              Write-Host "* No error occurred, finished! "
          } else {
              Write-Host "* Failed to compile and install! "
              exit 1
          }

      - name: Compiling and installing SDL3_image (MSVC)
        shell: pwsh
        run: |
          cd $HOME\git\SDL_image
          New-Item -ItemType Directory -Path build -Force
          cd build
          Write-Host "* Starting configure SDL3_image...."
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$HOME\Libs\SDL3" `
            -DCMAKE_INSTALL_PREFIX="$HOME\Libs\SDL3_image" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake" `
            -DSDLIMAGE_VENDORED=OFF
          Write-Host "* Compiling and installing SDL3_image...."
          cmake --build . -j4 --config Release --target install
          if ($LASTEXITCODE -eq 0) {
              Write-Host "* No error occurred, finished! "
          } else {
              Write-Host "* Failed to compile and install! "
              exit 1
          }

      - name: Compiling and installing SDL3_mixer (MSVC)
        shell: pwsh
        run: |
          cd $HOME\git\SDL_mixer
          Write-Host "* Downloading requirements libraries...."
          .\external\Get-GitModules.ps1
          New-Item -ItemType Directory -Path build -Force
          cd build
          Write-Host "* Starting configure SDL3_mixer...."
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$HOME\Libs\SDL3" `
            -DCMAKE_INSTALL_PREFIX="$HOME\Libs\SDL3_mixer" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          Write-Host "* Compiling and installing SDL3_mixer...."
          cmake --build . -j4 --config Release --target install
          if ($LASTEXITCODE -eq 0) {
              Write-Host "* No error occurred, finished! "
          } else {
              Write-Host "* Failed to compile and install! "
              exit 1
          }

      - name: Compiling and installing SDL3_ttf (MSVC)
        shell: pwsh
        run: |
          cd $HOME\git\SDL_ttf
          New-Item -ItemType Directory -Path build -Force
          cd build
          Write-Host "* Starting configure SDL3_ttf...."
          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$HOME\Libs\SDL3" `
            -DCMAKE_INSTALL_PREFIX="$HOME\Libs\SDL3_ttf" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          Write-Host "* Compiling and installing SDL3_ttf...."
          cmake --build . -j4 --config Release --target install
          if ($LASTEXITCODE -eq 0) {
              Write-Host "* No error occurred, finished! "
          } else {
              Write-Host "* Failed to compile and install! "
              exit 1
          }

      - name: Compiling and installing project
        shell: cmd
        run: |
          mkdir build
          cd build
          echo * Configuring project...
          cmake .. -G "Visual Studio 17 2022" -A x64 ^
                   -DSDL3_LIB=%USERPROFILE%\Libs\SDL3 ^
                   -DSDL3_IMAGE_LIB=%USERPROFILE%\Libs\SDL3_image ^
                   -DSDL3_MIXER_LIB=%USERPROFILE%\Libs\SDL3_mixer ^
                   -DSDL3_TTF_LIB=%USERPROFILE%\Libs\SDL3_ttf ^
                   -DBUILD_TEST=OFF ^
                   -DCMAKE_BUILD_TYPE=Release ^
                   -DCMAKE_INSTALL_PREFIX=%USERPROFILE%\Libs\MyEngine
          if %errorlevel% neq 0 (
            echo * CMake configure failed!
            exit /b 1
          )
          echo * Compiling and installing project...
          cmake --build . --config Release --target INSTALL -j4
          if %errorlevel% equ 0 (
            echo * No errors occurred, finished!
          ) else (
            echo * Failed to compile and install!
            exit /b 1
          )
