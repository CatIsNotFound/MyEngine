name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.1.1-beta)'
        required: true
        type: string

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
    - name: Get version from tag
      id: get_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        release_name: Release ${{ steps.get_version.outputs.version }}
        body: |
          ## MyEngine ${{ steps.get_version.outputs.version }}
          
          ### ðŸŽ‰ What's New
          This release includes the latest version of MyEngine 2D graphics framework.
          
          ### ðŸ“¦ Downloads
          - **Windows**: Download `MyEngine-windows-Release.zip`
          - **Linux**: Download `MyEngine-linux-Release.zip`
          - **macOS**: Download `MyEngine-macos-Release.zip`
          
          ### ðŸ”§ Installation
          1. Download the appropriate package for your platform
          2. Extract the contents
          3. Follow the installation instructions in the README.md
          
          ### ðŸ“‹ Requirements
          - C++20 compatible compiler
          - CMake 3.14+
          - SDL3 dependencies (included in packages)
          
          ### ðŸ“ Notes
          - This is a pre-release version
          - API may change in future versions
          - Please report any issues on GitHub
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.version, 'beta') || contains(steps.get_version.outputs.version, 'alpha') || contains(steps.get_version.outputs.version, 'rc') }}

  build-and-upload:
    name: Build and Upload ${{ matrix.platform }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_name: MyEngine-linux-Release
            asset_name: MyEngine-linux-Release.zip
          - os: windows-latest
            platform: windows
            artifact_name: MyEngine-windows-Release
            asset_name: MyEngine-windows-Release.zip
          - os: macos-latest
            platform: macos
            artifact_name: MyEngine-macos-Release
            asset_name: MyEngine-macos-Release.zip
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Restore cached dependencies
      id: cache-sdl-restore
      uses: actions/cache/restore@v4
      with:
        path: |
          ${{github.workspace}}/SDL_install
          ${{github.workspace}}/SDL_image_install
          ${{github.workspace}}/SDL_mixer_install
          ${{github.workspace}}/SDL_ttf_install
        key: ${{ runner.os }}-sdl3-${{ hashFiles('.github/workflows/dependencies.yml') }}
        restore-keys: |
          ${{ runner.os }}-sdl3-

    - name: Setup build environment (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          libasound2-dev \
          libpulse-dev \
          libaudio-dev \
          libjack-dev \
          libsndio-dev \
          libsamplerate0-dev \
          libudev-dev \
          libwayland-dev \
          libx11-dev \
          libxext-dev \
          libxrandr-dev \
          libxcursor-dev \
          libxinerama-dev \
          libxi-dev \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          libdbus-1-dev \
          libibus-1.0-dev \
          libfcitx-5-dev \
          libgtk-3-dev \
          zip

    - name: Setup build environment (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install cmake ninja pkg-config zip

    - name: Setup build environment (Windows)
      if: matrix.os == 'windows-latest'
      uses: microsoft/setup-msbuild@v1.3

    - name: Check if dependencies are cached
      id: check-deps
      run: |
        if [ -d "${{github.workspace}}/SDL_install" ] && \
           [ -d "${{github.workspace}}/SDL_image_install" ] && \
           [ -d "${{github.workspace}}/SDL_mixer_install" ] && \
           [ -d "${{github.workspace}}/SDL_ttf_install" ]; then
          echo "cached=true" >> $GITHUB_OUTPUT
        else
          echo "cached=false" >> $GITHUB_OUTPUT
        fi
      shell: bash

    - name: Build dependencies if not cached
      if: steps.check-deps.outputs.cached == 'false'
      run: |
        echo "Building dependencies from source..."
        # Build SDL3
        git clone https://github.com/libsdl-org/SDL.git ${{github.workspace}}/SDL
        cd ${{github.workspace}}/SDL
        git checkout main
        cmake -B build -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/SDL_install \
          -DSDL_SHARED=ON \
          -DSDL_STATIC=ON
        cmake --build build --config Release
        cmake --install build --config Release

        # Build SDL3_image
        git clone https://github.com/libsdl-org/SDL_image.git ${{github.workspace}}/SDL_image
        cd ${{github.workspace}}/SDL_image
        git checkout main
        cmake -B build -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/SDL_image_install \
          -DSDL3_DIR=${{github.workspace}}/SDL_install/lib/cmake/SDL3 \
          -DSDL3IMAGE_VENDORED=ON \
          -DSDL3IMAGE_DEPS_SHARED=ON \
          -DSDL3IMAGE_SAMPLES=OFF
        cmake --build build --config Release
        cmake --install build --config Release

        # Build SDL3_mixer
        git clone https://github.com/libsdl-org/SDL_mixer.git ${{github.workspace}}/SDL_mixer
        cd ${{github.workspace}}/SDL_mixer
        git checkout main
        cmake -B build -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/SDL_mixer_install \
          -DSDL3_DIR=${{github.workspace}}/SDL_install/lib/cmake/SDL3 \
          -DSDL3MIXER_VENDORED=ON \
          -DSDL3MIXER_DEPS_SHARED=ON \
          -DSDL3MIXER_SAMPLES=OFF
        cmake --build build --config Release
        cmake --install build --config Release

        # Build SDL3_ttf
        git clone https://github.com/libsdl-org/SDL_ttf.git ${{github.workspace}}/SDL_ttf
        cd ${{github.workspace}}/SDL_ttf
        git checkout main
        cmake -B build -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/SDL_ttf_install \
          -DSDL3_DIR=${{github.workspace}}/SDL_install/lib/cmake/SDL3 \
          -DSDL3TTF_VENDORED=ON \
          -DSDL3TTF_DEPS_SHARED=ON \
          -DSDL3TTF_SAMPLES=OFF
        cmake --build build --config Release
        cmake --install build --config Release

    - name: Configure MyEngine with CMake
      run: |
        cmake -B ${{github.workspace}}/build -G "Unix Makefiles" \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/MyEngine_install \
          -DSDL3_LIB=${{github.workspace}}/SDL_install \
          -DSDL3_IMAGE_LIB=${{github.workspace}}/SDL_image_install \
          -DSDL3_MIXER_LIB=${{github.workspace}}/SDL_mixer_install \
          -DSDL3_TTF_LIB=${{github.workspace}}/SDL_ttf_install \
          -DBUILD_TEST=OFF

    - name: Build MyEngine
      run: cmake --build ${{github.workspace}}/build --config Release

    - name: Install MyEngine
      run: cmake --install ${{github.workspace}}/build --config Release

    - name: Create package
      run: |
        cd ${{github.workspace}}/MyEngine_install
        if [ "${{ matrix.platform }}" = "windows" ]; then
          7z a -r ${{github.workspace}}/${{ matrix.asset_name }} .
        else
          zip -r ${{github.workspace}}/${{ matrix.asset_name }} .
        fi
      shell: bash

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ${{github.workspace}}/${{ matrix.asset_name }}
        asset_name: ${{ matrix.asset_name }}
        asset_content_type: application/zip

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{github.workspace}}/MyEngine_install/

  update-release-notes:
    name: Update Release Notes
    needs: [create-release, build-and-upload]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update release notes
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const version = '${{ needs.create-release.outputs.version }}';
          const release_id = '${{ needs.create-release.outputs.upload_url }}'.split('/').pop();
          
          // Add additional release notes or changelog here
          const release_notes = `
          ## Downloads
          
          - **Windows**: [MyEngine-windows-Release.zip](https://github.com/${{ github.repository }}/releases/download/${version}/MyEngine-windows-Release.zip)
          - **Linux**: [MyEngine-linux-Release.zip](https://github.com/${{ github.repository }}/releases/download/${version}/MyEngine-linux-Release.zip)
          - **macOS**: [MyEngine-macos-Release.zip](https://github.com/${{ github.repository }}/releases/download/${version}/MyEngine-macos-Release.zip)
          
          ## Installation
          
          1. Download the appropriate package for your platform
          2. Extract the contents to your desired location
          3. Follow the integration instructions in README.md
          
          ## System Requirements
          
          - **Windows**: Windows 10 or later, Visual Studio 2019 or later
          - **Linux**: Ubuntu 20.04 or later, GCC 9+ or Clang 10+
          - **macOS**: macOS 11.0 or later, Xcode 12+
          
          ## License
          
          This project is licensed under the MIT License. See LICENSE file for details.
          `;
          
          await github.rest.repos.updateRelease({
            owner: context.repo.owner,
            repo: context.repo.repo,
            release_id: release_id,
            body: release_notes
          });